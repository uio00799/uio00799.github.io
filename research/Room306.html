<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room 306 â€” SQL Injection Forensics Challenge (HTML)</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Smooth scrolling for logs container */
    #logsContainer { scroll-behavior: smooth; }
    /* Mono font nicer on Windows */
    @font-face {
      font-family: "JetBrainsMono";
      src: local("JetBrains Mono"), local("JetBrainsMono");
    }
    .font-mono { font-family: JetBrainsMono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* Handy utility for hidden via classList */
    .is-hidden { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 p-4 md:p-6 font-mono">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border-2 border-cyan-400 rounded-lg p-4 md:p-6 mb-6 shadow-2xl shadow-cyan-500/20">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
        <div class="flex items-center gap-3">
          <div class="bg-cyan-500 p-2 rounded-lg">
            <i data-lucide="database" class="w-8 h-8 text-white"></i>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-cyan-400 tracking-wider">ROOM 306</h1>
            <p class="text-sm md:text-base text-cyan-300">SQL Injection Forensics Challenge</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="headerLocked" class="bg-red-500 p-3 rounded-full">
            <i data-lucide="lock" class="w-8 h-8 text-white"></i>
          </div>
          <div id="headerUnlocked" class="bg-green-500 p-3 rounded-full animate-pulse is-hidden">
            <i data-lucide="unlock" class="w-8 h-8 text-white"></i>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-3 md:p-4 mb-4 border border-cyan-500/30">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="shield" class="w-5 h-5 text-yellow-400"></i>
          <span class="text-yellow-400 font-bold text-sm md:text-base">MISSION BRIEFING</span>
        </div>
        <p class="text-gray-300 text-sm md:text-base">Exploit SQL vulnerabilities to extract the hidden keyword and unlock the door</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all">
          <div class="text-gray-400 text-xs mb-1">Total Attempts</div>
          <div id="attemptsCount" class="text-white font-bold text-xl md:text-2xl">0</div>
        </div>
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all">
          <div class="text-gray-400 text-xs mb-1">Stage Attempts</div>
          <div id="stageAttemptsCount" class="text-cyan-400 font-bold text-xl md:text-2xl">0</div>
        </div>
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-3 border border-gray-700 hover:border-yellow-500 transition-all">
          <div class="text-gray-400 text-xs mb-1">Current Stage</div>
          <div id="currentStageCount" class="text-yellow-400 font-bold text-xl md:text-2xl">1/3</div>
        </div>
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-3 border border-gray-700 hover:border-yellow-500 transition-all">
          <div class="text-gray-400 text-xs mb-1 flex items-center gap-1">
            <i data-lucide="zap" class="w-3 h-3"></i>
            Hints Unlocked
          </div>
          <div id="hintsUnlockedCount" class="font-bold text-xl md:text-2xl text-gray-600">0/3</div>
        </div>
      </div>
    </div>

    <!-- Success Screen -->
    <div id="successPanel" class="bg-gradient-to-r from-green-900 via-emerald-900 to-green-900 border-2 border-green-400 rounded-lg p-6 mb-6 shadow-2xl shadow-green-500/30 animate-pulse is-hidden">
      <div class="flex items-center gap-4 mb-4">
        <div class="bg-green-500 p-3 rounded-full">
          <i data-lucide="unlock" class="w-12 h-12 text-white"></i>
        </div>
        <div>
          <h2 class="text-3xl md:text-4xl font-bold text-green-400 mb-1">MISSION COMPLETE!</h2>
          <p class="text-green-300 text-lg">Outstanding work, security researcher!</p>
        </div>
      </div>
      <div class="bg-black/50 rounded-lg p-5 mb-4 border-2 border-green-500">
        <div class="flex items-center gap-3 justify-center">
          <span class="text-green-300 text-xl">Extracted Keyword:</span>
          <span id="foundKeyword" class="font-bold text-4xl md:text-5xl text-white tracking-wider bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">AND</span>
        </div>
      </div>
      <div class="flex items-center justify-center gap-2 text-gray-300">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span>Door 306 is now unlocked. Proceed to next challenge.</span>
      </div>
    </div>

    <!-- Stage Info (hidden on success) -->
    <div id="stageInfoContainer" class="bg-gradient-to-r from-gray-800 to-gray-900 border-2 border-yellow-500 rounded-lg p-4 md:p-6 mb-6 shadow-xl">
      <div class="flex items-start gap-3 mb-4">
        <div class="bg-yellow-500 p-2 rounded-lg flex-shrink-0">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-black"></i>
        </div>
        <div class="flex-1">
          <h2 id="stageTitle" class="text-lg md:text-xl font-bold text-yellow-400 mb-2">Stage 1: Authentication Bypass</h2>
          <p id="stageDesc" class="text-gray-300 text-sm md:text-base mb-3">A vulnerable login form is exposed. The password field is injectable.</p>
          <div class="bg-blue-950 border-l-4 border-blue-500 rounded p-3 mb-3">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i>
              <span class="text-blue-400 text-xs md:text-sm font-bold">OBJECTIVE</span>
            </div>
            <div id="stageObjective" class="text-blue-200 text-sm">Bypass authentication to gain access to the system</div>
          </div>
        </div>
      </div>
      <div class="bg-black/70 p-4 rounded-lg border border-cyan-500/30">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="terminal" class="w-4 h-4 text-cyan-400"></i>
          <span class="text-cyan-400 text-xs font-bold">VULNERABLE SQL QUERY</span>
        </div>
        <code id="stageCode" class="text-cyan-300 text-xs md:text-sm block break-all">SELECT * FROM users WHERE username='admin' AND password='[YOUR_INPUT]'</code>
      </div>
    </div>

    <!-- SQL Console (hidden on success) -->
    <div id="consoleContainer" class="bg-black border-2 border-cyan-400 rounded-lg p-4 md:p-6 mb-6 shadow-2xl shadow-cyan-500/20">
      <div class="flex items-center gap-2 mb-4">
        <i data-lucide="terminal" class="w-5 h-5 text-cyan-400"></i>
        <span class="text-cyan-400 font-bold text-sm md:text-base tracking-wider">SQL INJECTION CONSOLE</span>
        <div class="flex-1"></div>
        <div class="bg-cyan-500/20 px-2 py-1 rounded text-cyan-400 text-xs">ACTIVE</div>
      </div>

      <textarea id="sqlInput" rows="4" placeholder="Enter your SQL injection payload... (Press Enter to execute, Shift+Enter for new line)" class="w-full bg-gray-950 text-green-400 border-2 border-cyan-700 rounded-lg px-4 py-3 focus:outline-none focus:border-cyan-400 font-mono text-sm md:text-base min-h-[100px] resize-y placeholder-gray-600 transition-all"></textarea>

      <div class="flex flex-col sm:flex-row gap-3 mt-4">
        <button id="executeBtn" class="flex-1 bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-500 hover:to-cyan-400 text-white px-6 py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-cyan-500/50 transform hover:scale-105">
          <i data-lucide="terminal" class="w-5 h-5"></i>
          EXECUTE QUERY
        </button>
        <button id="hintBtn" class="flex-1 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white px-6 py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 shadow-lg transform hover:scale-105">
          <i data-lucide="lightbulb" class="w-5 h-5"></i>
          <span id="hintBtnLabel">SHOW HINTS</span>
        </button>
      </div>

      <!-- Hint Panel -->
      <div id="hintPanel" class="mt-5 bg-gradient-to-r from-gray-900 to-gray-800 border-2 border-yellow-500 rounded-lg p-4 shadow-xl is-hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-400"></i>
            <span class="text-yellow-400 font-bold">PROGRESSIVE HINT SYSTEM</span>
          </div>
          <div class="bg-yellow-500/20 px-3 py-1 rounded text-yellow-400 text-xs">Unlocks at 10, 25, 50 attempts</div>
        </div>

        <!-- Level 0 (Locked) -->
        <div id="hintsLocked" class="text-center py-8 bg-gray-950 rounded-lg border border-gray-700">
          <i data-lucide="lock" class="w-12 h-12 mx-auto mb-3 text-gray-600"></i>
          <div class="text-gray-400 text-lg mb-2">No Hints Available Yet</div>
          <div class="text-white font-bold text-2xl">
            <span id="nextHintCount">10</span>
            <span class="text-gray-500 text-base"> more attempts</span>
          </div>
          <div class="text-gray-500 text-sm mt-1">to unlock Level 1 Hint</div>
        </div>

        <!-- Level 1 -->
        <div id="hintLevel1" class="mb-3 p-4 bg-yellow-900/30 rounded-lg border-l-4 border-yellow-500 shadow-lg is-hidden">
          <div class="flex items-center gap-2 mb-2">
            <i data-lucide="check-circle" class="w-5 h-5 text-yellow-400"></i>
            <span class="text-yellow-300 font-bold">Level 1 Hint</span>
            <span class="bg-yellow-500/30 px-2 py-0.5 rounded text-xs text-yellow-300">Unlocked at 10</span>
          </div>
          <div id="hintL1Text" class="text-yellow-100 text-sm leading-relaxed"></div>
        </div>

        <!-- Level 2 -->
        <div id="hintLevel2" class="mb-3 p-4 bg-orange-900/30 rounded-lg border-l-4 border-orange-500 shadow-lg is-hidden">
          <div class="flex items-center gap-2 mb-2">
            <i data-lucide="check-circle" class="w-5 h-5 text-orange-400"></i>
            <span class="text-orange-300 font-bold">Level 2 Hint</span>
            <span class="bg-orange-500/30 px-2 py-0.5 rounded text-xs text-orange-300">Unlocked at 25</span>
          </div>
          <div id="hintL2Text" class="text-orange-100 text-sm leading-relaxed"></div>
        </div>

        <!-- Level 3 (Full solution) -->
        <div id="hintLevel3" class="p-4 bg-red-900/30 rounded-lg border-l-4 border-red-500 shadow-lg is-hidden">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="check-circle" class="w-5 h-5 text-red-400"></i>
            <span class="text-red-300 font-bold">Level 3 Hint</span>
            <span class="bg-red-500/30 px-2 py-0.5 rounded text-xs text-red-300">Unlocked at 50</span>
          </div>
          <div id="hintL3Text" class="text-red-100 mb-3 text-sm leading-relaxed"></div>
          <div class="bg-black/70 p-4 rounded-lg border-2 border-red-500">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400"></i>
              <span class="text-red-400 text-xs font-bold">FULL SOLUTION</span>
            </div>
            <pre id="hintFullSolution" class="text-red-200 font-mono text-xs md:text-sm whitespace-pre-wrap break-all"></pre>
          </div>
        </div>

        <!-- Next unlock box -->
        <div id="nextHintAttemptsBox" class="mt-3 p-3 bg-gray-950 rounded-lg text-center border border-gray-700">
          <div class="text-gray-400 text-sm mb-1">Next hint unlocks in</div>
          <div class="text-white font-bold text-xl" id="nextHintAttempts">10</div>
          <div class="text-gray-500 text-xs">attempts</div>
        </div>
      </div>
    </div>

    <!-- Activity Logs -->
    <div class="bg-black border-2 border-green-500 rounded-lg p-4 md:p-6 mb-6 shadow-2xl shadow-green-500/20 max-h-96 overflow-y-auto" id="logsWrapper">
      <div class="flex items-center gap-2 mb-4 sticky top-0 bg-black pb-2">
        <i data-lucide="shield" class="w-5 h-5 text-green-400"></i>
        <span class="text-green-400 font-bold tracking-wider">SYSTEM ACTIVITY LOGS</span>
        <div class="flex-1"></div>
        <div class="bg-green-500/20 px-2 py-1 rounded text-green-400 text-xs">MONITORING</div>
      </div>
      <div id="logsEmpty" class="text-center py-12 text-gray-600">
        <i data-lucide="terminal" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
        <div class="text-sm">Awaiting query execution...</div>
      </div>
      <div id="logsContainer" class="space-y-1"></div>
    </div>

    <!-- Knowledge Base -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-cyan-500/30 rounded-lg p-4 md:p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <i data-lucide="database" class="w-5 h-5 text-cyan-400"></i>
        <h3 class="text-cyan-400 font-bold">Required IT Knowledge & Skills</h3>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ SQL Injection Fundamentals</div>
          <div class="text-gray-400 text-xs">Authentication bypass techniques</div>
        </div>
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ UNION-based Injection</div>
          <div class="text-gray-400 text-xs">Combining multiple query results</div>
        </div>
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ Database Enumeration</div>
          <div class="text-gray-400 text-xs">Using information_schema tables</div>
        </div>
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ Data Exfiltration</div>
          <div class="text-gray-400 text-xs">Extracting sensitive information</div>
        </div>
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ SQL Query Syntax</div>
          <div class="text-gray-400 text-xs">SELECT, FROM, WHERE, UNION</div>
        </div>
        <div class="bg-gray-900/70 rounded-lg p-3 border border-gray-700 hover:border-cyan-500 transition-all group">
          <div class="text-cyan-300 font-bold text-sm mb-1 group-hover:text-cyan-400 transition-colors">â€¢ Web Security Concepts</div>
          <div class="text-gray-400 text-xs">OWASP Top 10 vulnerabilities</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-gray-500 text-xs md:text-sm space-y-2 pb-4">
      <div class="flex items-center justify-center gap-2">
        <i data-lucide="shield" class="w-4 h-4"></i>
        <span>Room 306: SQL Injection Forensics Challenge</span>
      </div>
      <div class="flex items-center justify-center gap-2">
        <span>Difficulty:</span>
        <span id="difficultyStars" class="text-yellow-400 font-mono">â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†</span>
        <span id="difficultyNumeric" class="text-white font-bold">(8/10)</span>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    let stage = 1;
    let sqlInput = "";
    let logs = [];
    let showHint = false;
    let attempts = 0;
    let stageAttempts = 0;
    let foundKeyword = "";
    let showSuccess = false;
    let autoHintLevel = 0; // 0..3

    const hints = {
      stage1: [
        "SQL injection allows you to manipulate database queries by injecting malicious SQL code.",
        "Try closing the password string with a single quote (') and then adding a condition that's always true.",
        "Use the OR operator to bypass authentication. For example: '1'='1' is always true, which will return all records.",
        "Complete payload: ' OR '1'='1\n\nThis closes the password field and adds an OR condition that's always true, bypassing authentication."
      ],
      stage2: [
        "You need to discover what tables exist in the database schema.",
        "UNION SELECT allows you to combine results from different queries. The number of columns must match.",
        "The information_schema database contains metadata about all tables. Use information_schema.tables to enumerate them.",
        "Full payload: ' UNION SELECT NULL, table_name FROM information_schema.tables--\n\nThis combines your query with a query that lists all table names."
      ],
      stage3: [
        "The hidden_vault table has been discovered. It contains sensitive credentials.",
        "Use UNION SELECT to extract data from the hidden_vault table. You need to retrieve both username and password.",
        "The hidden_vault table has columns: id, username, password. Select the username and password fields.",
        "Complete payload: ' UNION SELECT username, password FROM hidden_vault--\n\nOr more specific: ' UNION SELECT username, password FROM hidden_vault WHERE id=1--"
      ]
    };

    const stageInfo = {
      1: {
        title: "Stage 1: Authentication Bypass",
        desc: "A vulnerable login form is exposed. The password field is injectable.",
        code: "SELECT * FROM users WHERE username='admin' AND password='[YOUR_INPUT]'",
        objective: "Bypass authentication to gain access to the system"
      },
      2: {
        title: "Stage 2: Database Enumeration",
        desc: "Discover hidden tables in the database schema using UNION injection.",
        code: "SELECT id, name FROM users WHERE id='[YOUR_INPUT]'",
        objective: "Find the hidden_vault table name"
      },
      3: {
        title: "Stage 3: Data Exfiltration",
        desc: "Extract sensitive credentials from the hidden_vault table.",
        code: "SELECT * FROM products WHERE category='[YOUR_INPUT]'",
        objective: "Retrieve username and password from hidden_vault"
      }
    };

    // ---------------------------
    // DOM Refs
    // ---------------------------
    const attemptsCount = document.getElementById('attemptsCount');
    const stageAttemptsCount = document.getElementById('stageAttemptsCount');
    const currentStageCount = document.getElementById('currentStageCount');
    const hintsUnlockedCount = document.getElementById('hintsUnlockedCount');

    const headerLocked = document.getElementById('headerLocked');
    const headerUnlocked = document.getElementById('headerUnlocked');

    const successPanel = document.getElementById('successPanel');
    const keywordSpan = document.getElementById('foundKeyword');

    const stageInfoContainer = document.getElementById('stageInfoContainer');
    const stageTitle = document.getElementById('stageTitle');
    const stageDesc = document.getElementById('stageDesc');
    const stageObjective = document.getElementById('stageObjective');
    const stageCode = document.getElementById('stageCode');

    const consoleContainer = document.getElementById('consoleContainer');
    const sqlInputEl = document.getElementById('sqlInput');
    const executeBtn = document.getElementById('executeBtn');
    const hintBtn = document.getElementById('hintBtn');
    const hintBtnLabel = document.getElementById('hintBtnLabel');

    const hintPanel = document.getElementById('hintPanel');
    const hintsLocked = document.getElementById('hintsLocked');
    const hintLevel1 = document.getElementById('hintLevel1');
    const hintLevel2 = document.getElementById('hintLevel2');
    const hintLevel3 = document.getElementById('hintLevel3');
    const hintL1Text = document.getElementById('hintL1Text');
    const hintL2Text = document.getElementById('hintL2Text');
    const hintL3Text = document.getElementById('hintL3Text');
    const hintFullSolution = document.getElementById('hintFullSolution');

    const nextHintAttemptsBox = document.getElementById('nextHintAttemptsBox');
    const nextHintAttempts = document.getElementById('nextHintAttempts');
    const nextHintCount = document.getElementById('nextHintCount');

    const logsWrapper = document.getElementById('logsWrapper');
    const logsEmpty = document.getElementById('logsEmpty');
    const logsContainer = document.getElementById('logsContainer');

    const difficultyStars = document.getElementById('difficultyStars');
    const difficultyNumeric = document.getElementById('difficultyNumeric');

    // ---------------------------
    // Helpers
    // ---------------------------
    function timeNow() {
      return new Intl.DateTimeFormat('en-GB', {
        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).format(new Date());
    }

    function addLog(message, type = 'info') {
      const entry = { message, type, time: timeNow() };
      logs.push(entry);
      // Render the new log at the end (latest at bottom)
      renderLogs();
    }

    function renderLogs() {
      if (logs.length === 0) {
        logsEmpty.classList.remove('is-hidden');
        logsContainer.innerHTML = '';
        return;
      }
      logsEmpty.classList.add('is-hidden');
      // Build rows
      const frag = document.createDocumentFragment();
      logs.forEach((log) => {
        const row = document.createElement('div');
        row.className = 'flex gap-3 text-xs md:text-sm hover:bg-gray-900/50 p-2 rounded transition-all group';

        const time = document.createElement('span');
        time.className = 'text-gray-600 flex-shrink-0 font-mono';
        time.textContent = `[${log.time}]`;

        const msg = document.createElement('span');
        msg.className = 'flex items-center gap-2 group-hover:text-white transition-colors';
        if (log.type === 'success') msg.classList.add('text-green-400');
        else if (log.type === 'error') msg.classList.add('text-red-400');
        else if (log.type === 'warning') msg.classList.add('text-yellow-400');
        else msg.classList.add('text-gray-400');

        if (log.type === 'success') msg.innerHTML = `<svg class="w-3 h-3 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span class="break-all"></span>`;
        else if (log.type === 'error') msg.innerHTML = `<svg class="w-3 h-3 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span class="break-all"></span>`;
        else if (log.type === 'warning') msg.innerHTML = `<svg class="w-3 h-3 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span class="break-all"></span>`;
        else msg.innerHTML = `<span class="break-all"></span>`;

        msg.querySelector('span').textContent = log.message;
        row.appendChild(time);
        row.appendChild(msg);
        frag.appendChild(row);
      });
      logsContainer.innerHTML = '';
      logsContainer.appendChild(frag);
      // scroll to bottom
      logsWrapper.scrollTop = logsWrapper.scrollHeight;
    }

    function getNextHintAttempts() {
      if (autoHintLevel === 0) return Math.max(0, 10 - stageAttempts);
      if (autoHintLevel === 1) return Math.max(0, 25 - stageAttempts);
      if (autoHintLevel === 2) return Math.max(0, 50 - stageAttempts);
      return 0;
    }

    function getDifficultyStars() {
      const levels = [8, 7, 6, 5];
      const level = levels[autoHintLevel];
      return 'â˜…'.repeat(level) + 'â˜†'.repeat(10 - level);
    }

    function updateDifficulty() {
      difficultyStars.textContent = getDifficultyStars();
      const numeric = (autoHintLevel === 0) ? '8/10' : (autoHintLevel === 1) ? '7/10' : (autoHintLevel === 2) ? '6/10' : '5/10';
      difficultyNumeric.textContent = `(${numeric})`;
    }

    function updateHeaderLock() {
      headerLocked.classList.toggle('is-hidden', showSuccess);
      headerUnlocked.classList.toggle('is-hidden', !showSuccess);
    }

    function updateCounters() {
      attemptsCount.textContent = attempts;
      stageAttemptsCount.textContent = stageAttempts;
      currentStageCount.textContent = `${stage}/3`;
      hintsUnlockedCount.textContent = `${autoHintLevel}/3`;
      hintsUnlockedCount.classList.toggle('text-gray-600', autoHintLevel === 0);
      hintsUnlockedCount.classList.toggle('text-yellow-400', autoHintLevel > 0);
    }

    function updateStageInfo() {
      const info = stageInfo[stage];
      stageTitle.textContent = info.title;
      stageDesc.textContent = info.desc;
      stageObjective.textContent = info.objective;
      stageCode.textContent = info.code;
    }

    function updateSuccessPanel() {
      successPanel.classList.toggle('is-hidden', !showSuccess);
      stageInfoContainer.classList.toggle('is-hidden', showSuccess);
      consoleContainer.classList.toggle('is-hidden', showSuccess);
      if (foundKeyword) keywordSpan.textContent = foundKeyword.toUpperCase();
    }

    function updateHintPanel() {
      // button pulse when autoHintLevel>0 and panel hidden
      if (autoHintLevel > 0 && !showHint) {
        hintBtn.classList.add('animate-pulse');
        hintBtn.classList.remove('bg-gradient-to-r', 'from-gray-700', 'to-gray-600');
        hintBtn.classList.add('bg-gradient-to-r', 'from-yellow-600', 'to-yellow-500', 'hover:from-yellow-500', 'hover:to-yellow-400');
      } else {
        hintBtn.classList.remove('animate-pulse');
        if (autoHintLevel > 0) {
          hintBtn.classList.remove('from-gray-700', 'to-gray-600');
          hintBtn.classList.add('from-yellow-600', 'to-yellow-500', 'hover:from-yellow-500', 'hover:to-yellow-400');
        } else {
          hintBtn.classList.remove('from-yellow-600', 'to-yellow-500');
          hintBtn.classList.add('from-gray-700', 'to-gray-600', 'hover:from-gray-600', 'hover:to-gray-500');
        }
      }
      hintBtnLabel.textContent = showHint ? 'HIDE HINTS' : `SHOW HINTS${autoHintLevel > 0 ? ` (${autoHintLevel})` : ''}`;

      hintPanel.classList.toggle('is-hidden', !showHint);

      // Populate hints content for current stage
      const bucket = hints[`stage${stage}`];
      hintL1Text.textContent = bucket[0];
      hintL2Text.textContent = bucket[1];
      hintL3Text.textContent = bucket[2];
      hintFullSolution.textContent = bucket[3];

      // Levels visibility
      hintsLocked.classList.toggle('is-hidden', autoHintLevel > 0);
      hintLevel1.classList.toggle('is-hidden', autoHintLevel < 1);
      hintLevel2.classList.toggle('is-hidden', autoHintLevel < 2);
      hintLevel3.classList.toggle('is-hidden', autoHintLevel < 3);

      // Next hint box
      const remaining = getNextHintAttempts();
      nextHintAttempts.textContent = remaining;
      nextHintCount.textContent = remaining; // for locked card text
      nextHintAttemptsBox.classList.toggle('is-hidden', autoHintLevel >= 3 || stageAttempts >= 50);
    }

    function resetForNextStage(nextStage) {
      stage = nextStage;
      stageAttempts = 0;
      autoHintLevel = 0;
      sqlInputEl.value = '';
      updateStageInfo();
      updateCounters();
      updateHintPanel();
      updateDifficulty();
    }

    // ---------------------------
    // Stage Checks
    // ---------------------------
    function checkStage1(input) {
      const normalized = input.trim().toLowerCase();
      if (normalized.includes("'") && normalized.includes("or") && (normalized.includes("'1'='1'") || normalized.includes("1=1"))) {
        addLog("\u2713 Authentication bypassed successfully!", 'success');
        addLog("System breach detected. Accessing database tables...", 'info');
        setTimeout(() => {
          resetForNextStage(2);
        }, 1500);
        return true;
      }
      return false;
    }

    function checkStage2(input) {
      const normalized = input.trim().toLowerCase();
      if (normalized.includes("union") && normalized.includes("select") && normalized.includes("information_schema") && (normalized.includes("table"))) {
        addLog("\u2713 Table enumeration successful!", 'success');
        addLog("Discovered tables: users, products, sessions, hidden_vault", 'success');
        addLog("Target identified: hidden_vault", 'warning');
        addLog("Initiating data exfiltration...", 'info');
        setTimeout(() => {
          resetForNextStage(3);
        }, 1500);
        return true;
      }
      return false;
    }

    function checkStage3(input) {
      const normalized = input.trim().toLowerCase();
      if (normalized.includes("union") && normalized.includes("select") && normalized.includes("hidden_vault") && (normalized.includes("username") || normalized.includes("password") || normalized.includes("*"))) {
        addLog("\u2713 Data extraction complete!", 'success');
        addLog("Raw data retrieved from hidden_vault:", 'info');
        addLog("  \u2192 username: admin", 'success');
        addLog("  \u2192 password: YW5k (Base64 encoded)", 'success');
        addLog("Decoding password...", 'info');
        setTimeout(() => {
          const decoded = atob('YW5k'); // 'and'
          addLog(`Base64 decode: YW5k \u2192 ${decoded}`, 'success');
          addLog("\ud83d\udd10 Final keyword extracted: AND", 'success');
          foundKeyword = decoded;
          showSuccess = true;
          updateHeaderLock();
          updateSuccessPanel();
        }, 2000);
        return true;
      }
      return false;
    }

    // ---------------------------
    // Submit / Keyboard
    // ---------------------------
    function handleSubmit() {
      const value = sqlInputEl.value;
      if (value.trim() === '') {
        addLog("\u26a0 Empty query - Please enter a SQL injection payload", 'error');
        return;
      }

      attempts += 1;
      stageAttempts += 1;
      addLog(`[EXEC] ${value}`, 'info');

      let success = false;
      if (stage === 1) success = checkStage1(value);
      else if (stage === 2) success = checkStage2(value);
      else if (stage === 3) success = checkStage3(value);

      if (!success) {
        addLog("\u2717 Query failed or incomplete - Try again", 'error');
        // Auto hint unlocks
        const currentAttempts = stageAttempts;
        if (currentAttempts === 10 && autoHintLevel < 1) {
          autoHintLevel = 1;
          addLog("\ud83d\udca1 HINT LEVEL 1 UNLOCKED! Click 'SHOW HINTS' button.", 'warning');
        } else if (currentAttempts === 25 && autoHintLevel < 2) {
          autoHintLevel = 2;
          addLog("\ud83d\udca1 HINT LEVEL 2 UNLOCKED! More detailed guidance available.", 'warning');
        } else if (currentAttempts === 50 && autoHintLevel < 3) {
          autoHintLevel = 3;
          addLog("\ud83d\udca1 HINT LEVEL 3 UNLOCKED! Solution revealed!", 'warning');
        }
      } else {
        sqlInputEl.value = '';
      }

      updateCounters();
      updateHintPanel();
      updateDifficulty();
    }

    sqlInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSubmit();
      }
    });

    executeBtn.addEventListener('click', handleSubmit);

    hintBtn.addEventListener('click', () => {
      showHint = !showHint;
      updateHintPanel();
    });

    // ---------------------------
    // Initial Render
    // ---------------------------
    function initialRender() {
      updateHeaderLock();
      updateCounters();
      updateStageInfo();
      updateHintPanel();
      updateDifficulty();
      renderLogs();
      lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', initialRender);
  </script>
</body>
</html>
